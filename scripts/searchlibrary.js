let systemIds=[],librariesData=[],prefecturesData={},prefSelect=document.getElementById("pref"),citySelect=document.getElementById("city"),DEFAULT_PREFECTURE="広島県",DEFAULT_CITY="東広島市";function populatePrefectures(){Object.keys(prefecturesData).forEach(e=>{var t=document.createElement("option");t.value=e,t.textContent=e,prefSelect.appendChild(t)})}function populateCities(e){citySelect.innerHTML='<option value="">市区町村を選択してください</option>',e&&prefecturesData[e]&&prefecturesData[e].forEach(e=>{var t=document.createElement("option");t.value=e,t.textContent=e,citySelect.appendChild(t)})}function setDefaultValues(){prefecturesData[DEFAULT_PREFECTURE]&&(populateCities(prefSelect.value=DEFAULT_PREFECTURE),prefecturesData[DEFAULT_PREFECTURE].includes(DEFAULT_CITY))&&(citySelect.value=DEFAULT_CITY)}function displayLibraries(e){var t=document.getElementById("search-results");t.innerHTML="",(librariesData=e)&&0<e.length?console.log("図書館データを取得しました。"):t.textContent="該当する図書館が見つかりませんでした。"}function searchBook(t,n,o,e=null){let r=`/searchBook?isbn=${encodeURIComponent(t)}&systemid=`+encodeURIComponent(n);e&&(r+="&session="+encodeURIComponent(e)),fetch(r).then(e=>{if(e.ok)return e.json();throw new Error("HTTPエラー! ステータスコード: "+e.status)}).then(e=>{1===e.continue?setTimeout(()=>{searchBook(t,n,o,e.session)},2e3):displayBookResults(e,o)}).catch(e=>{console.error("Error:",e);var t=document.getElementById("book-search-results"),n=document.createElement("div");n.textContent=o.formal+": 蔵書データの取得に失敗しました: "+e.message,t.appendChild(n)})}function displayBookResults(t,n){var e=document.getElementById("book-search-results"),o=document.createElement("div");if(o.innerHTML=`<h4>${n.formal}</h4>`,t.books&&"object"==typeof t.books){let e=!1;for(var r in t.books)if(t.books.hasOwnProperty(r)){var a,s,l,c,i=t.books[r];for(a in i)i.hasOwnProperty(a)&&(l=(s=i[a]).libkey||{}).hasOwnProperty(n.libkey)&&(c="貸出可"===l[n.libkey]?"o":"x",o.innerHTML+=`<p>${r} - 貸し出し状況: ${c}</p>`,s.reserveurl&&"貸出可"===l[n.libkey]&&((c=document.createElement("a")).href=s.reserveurl,c.textContent="予約",c.target="_blank",o.appendChild(c)),e=!0)}e||(o.innerHTML+="<p>該当する蔵書が見つかりませんでした。</p>")}else o.innerHTML+="<p>該当する蔵書が見つかりませんでした。</p>";e.appendChild(o)}prefSelect.addEventListener("change",function(){populateCities(this.value)}),document.getElementById("library-search-form").addEventListener("submit",function(e){e.preventDefault();e=`/searchLibrary?geocode=${encodeURIComponent(globalLongitude)},`+encodeURIComponent(globalLatitude);fetch(e).then(e=>{if(e.ok)return e.json();throw new Error("HTTPエラー! ステータスコード: "+e.status)}).then(e=>{displayLibraries(e)}).catch(e=>{console.error("Error:",e),document.getElementById("search-results").textContent="図書館データの取得に失敗しました: "+e.message})}),document.getElementById("book-search-form").addEventListener("submit",function(e){e.preventDefault();let t=document.getElementById("isbn").value;librariesData&&0!==librariesData.length?(document.getElementById("book-search-results").textContent="検索中...",librariesData.forEach(e=>{searchBook(t,e.systemid,e)})):document.getElementById("book-search-results").textContent="検索する図書館が見つかりません。"});